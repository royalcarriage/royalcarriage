---
import BaseLayout from '../layouts/BaseLayout.astro';
import CTAButton from '@packages/astro-components/CTAButton.astro';
import CallButton from '@packages/astro-components/CallButton.astro';
import { generateServiceSchema } from '@packages/astro-utils/schema';
import { getSiteConfig } from '@packages/astro-utils/config';
import { db } from '../lib/firebase';
import { collection, getDocs, query, where } from 'firebase/firestore';

const config = getSiteConfig('corporate');

interface Location {
  id: string;
  name: string;
  slug: string;
  type: string;
  area?: string;
  region?: string;
}

interface ServiceContent {
  locationId: string;
  serviceId: string;
  serviceName: string;
}

let locations: Location[] = [];
let contentByLocation: Record<string, ServiceContent[]> = {};

try {
  if (db) {
    const locSnap = await getDocs(collection(db, 'locations'));
    locations = locSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    })) as Location[];

    const contentQuery = query(
      collection(db, 'service_content'),
      where('websiteId', '==', 'chicagoexecutivecarservice'),
      where('approvalStatus', '==', 'approved')
    );
    const contentSnap = await getDocs(contentQuery);

    contentSnap.docs.forEach(doc => {
      const data = doc.data();
      const locId = data.locationId;
      if (!contentByLocation[locId]) {
        contentByLocation[locId] = [];
      }
      contentByLocation[locId].push({
        locationId: data.locationId,
        serviceId: data.serviceId,
        serviceName: data.serviceName
      });
    });
  }
} catch (error) {
  console.warn('[Locations] Error fetching data:', error);
}

const locationsByArea: Record<string, Location[]> = {};
locations.forEach(loc => {
  const area = loc.area || loc.region || 'Other Areas';
  if (!locationsByArea[area]) {
    locationsByArea[area] = [];
  }
  locationsByArea[area].push(loc);
});

const sortedAreas = Object.keys(locationsByArea).sort();
sortedAreas.forEach(area => {
  locationsByArea[area].sort((a, b) => a.name.localeCompare(b.name));
});

const areaNames: Record<string, string> = {
  'north': 'North & Northwest Suburbs',
  'north-suburbs': 'North Suburbs',
  'north-side': 'North Side Chicago',
  'south': 'South & Southwest Suburbs',
  'south-suburbs': 'South Suburbs',
  'south-side': 'South Side Chicago',
  'southwest': 'Southwest Suburbs',
  'west': 'Western Suburbs',
  'west-suburbs': 'Western Suburbs',
  'near-west': 'Near West Side',
  'downtown': 'Downtown Chicago',
  'Other Areas': 'Other Service Areas'
};

const serviceSchema = generateServiceSchema({
  config,
  serviceName: "Chicago Executive Car Service Areas",
  serviceDescription: "Executive car service throughout Chicago and suburbs. Professional corporate transportation in Naperville, Schaumburg, Oak Brook, and 200+ business locations.",
  serviceType: "Executive Transportation",
  url: Astro.url.pathname
});
---

<BaseLayout
  title="Executive Car Service Areas - Chicago & Suburbs | Corporate Transportation"
  description="Executive car service throughout Chicago and suburbs. Professional corporate transportation in Naperville, Schaumburg, Oak Brook, and 200+ business locations."
  canonical="/locations"
  schema={serviceSchema}
>
  <div class="bg-gradient-to-r from-slate-900 to-slate-700 text-white py-16">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Executive Car Service Areas</h1>
      <p class="text-xl text-slate-300 mb-6">Professional corporate transportation to {locations.length}+ Chicago business locations</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <CTAButton target="corporate" location="hero" size="lg" />
        <CallButton target="corporate" location="hero" size="lg" />
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-12">
    <div class="max-w-6xl mx-auto">
      <p class="text-lg text-gray-700 mb-8">
        Royal Carriage provides executive transportation throughout Chicago's business districts and suburban office parks.
        Our professional chauffeurs serve corporate clients in these locations.
      </p>

      {sortedAreas.map(area => (
        <div class="mb-10">
          <h2 class="text-2xl font-bold mb-4 text-gray-900 border-b-2 border-slate-600 pb-2">
            {areaNames[area] || area.charAt(0).toUpperCase() + area.slice(1).replace(/-/g, ' ')}
          </h2>
          <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {locationsByArea[area].map(loc => {
              const services = contentByLocation[loc.slug] || contentByLocation[loc.id] || [];
              const hasServices = services.length > 0;
              const firstService = services[0];

              return hasServices ? (
                <a
                  href={`/service/${loc.slug || loc.id}/${firstService.serviceId}`}
                  class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-slate-500 transition group"
                >
                  <div class="font-semibold text-gray-900 group-hover:text-slate-600">{loc.name}</div>
                  <div class="text-sm text-gray-500 mt-1">{services.length} service{services.length !== 1 ? 's' : ''} available</div>
                </a>
              ) : (
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="font-semibold text-gray-700">{loc.name}</div>
                  <div class="text-sm text-gray-400 mt-1">Coming soon</div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>

  <div class="bg-gray-100 py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-6 text-center">Corporate Services Available</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-slate-800">Business Districts</h3>
            <ul class="space-y-2 text-gray-700">
              <li>Loop & Downtown Chicago</li>
              <li>River North Business Centers</li>
              <li>O'Hare Corporate Corridor</li>
              <li>Oak Brook & Naperville Business Parks</li>
            </ul>
          </div>
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-slate-800">Executive Services</h3>
            <ul class="space-y-2 text-gray-700">
              <li>Airport to Office Transfers</li>
              <li>Multi-Stop Meeting Routes</li>
              <li>Client Entertainment</li>
              <li>Corporate Account Billing</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-slate-900 text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Book Executive Transportation</h2>
      <p class="text-xl text-slate-300 mb-6">Corporate accounts available for Chicago businesses</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <CTAButton target="corporate" location="bottom-cta" size="lg" variant="secondary" />
        <CallButton target="corporate" location="bottom-cta" size="lg" />
      </div>
    </div>
  </div>
</BaseLayout>
