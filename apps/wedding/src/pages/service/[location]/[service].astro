---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { db } from '../../../lib/firebase';
import { collection, query, where, getDocs } from 'firebase/firestore';

export async function getStaticPaths() {
  try {
    if (!db) {
      console.warn('[Astro Build] Firebase not initialized, returning empty paths');
      return [];
    }

    // Fetch all approved content for wedding website
    const contentQuery = query(
      collection(db, 'service_content'),
      where('websiteId', '==', 'chicagoweddingtransportation'),
      where('approvalStatus', '==', 'approved')
    );

    const snapshot = await getDocs(contentQuery);

    return snapshot.docs.map((doc) => {
      const data = doc.data();
      return {
        params: {
          location: data.locationId,
          service: data.serviceId,
        },
        props: {
          content: data,
          contentId: doc.id,
        },
      };
    });
  } catch (error) {
    console.warn('[Astro Build] Could not fetch service content:', error);
    return [];
  }
}

interface Props {
  content: {
    title: string;
    metaDescription: string;
    content: string;
    keywords: string[];
    aiQualityScore?: number;
    locationName?: string;
    serviceName?: string;
    recommendedVehicles?: string[];
    crossSellWebsites?: string[];
    internalLinks?: Array<{
      title: string;
      url: string;
      context: string;
    }>;
    schema?: Record<string, any>;
    ogImage?: string;
    breadcrumbs?: Array<{
      name: string;
      url: string;
    }>;
  };
  contentId: string;
}

const { content, contentId } = Astro.props;
const { location, service } = Astro.params;

// Sanitize HTML content
const sanitizeHtml = (html: string) => {
  return html
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '');
};

const metaTags = {
  title: content.title,
  description: content.metaDescription,
  ogImage: content.ogImage,
  canonical: `https://chicagoweddingtransportation.com/service/${service}/${location}`,
  schema: content.schema,
};
---

<BaseLayout {metaTags}>
  <div class="min-h-screen bg-white">
    <div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
      {/* Breadcrumb Navigation */}
      {content.breadcrumbs && content.breadcrumbs.length > 0 && (
        <nav class="mb-6 flex items-center space-x-2 text-sm">
          {content.breadcrumbs.map((crumb, index) => (
            <>
              <a href={crumb.url} class="text-blue-600 hover:underline">
                {crumb.name}
              </a>
              {index < content.breadcrumbs.length - 1 && (
                <span class="text-gray-400">/</span>
              )}
            </>
          ))}
        </nav>
      )}

      {/* Main Content */}
      <article class="prose prose-lg max-w-none">
        <h1 class="mb-4 text-4xl font-bold leading-tight text-gray-900">
          {content.title}
        </h1>

        <p class="lead mb-6 text-xl text-gray-600">
          {content.metaDescription}
        </p>

        <div
          class="prose-p:text-gray-700 mb-8 text-gray-800"
          set:html={sanitizeHtml(content.content)}
        />

        {/* Keywords Section */}
        {content.keywords && content.keywords.length > 0 && (
          <div class="my-8 rounded-lg bg-pink-50 p-6">
            <h3 class="mb-3 text-lg font-semibold text-gray-900">Related Keywords</h3>
            <div class="flex flex-wrap gap-2">
              {content.keywords.slice(0, 15).map((keyword) => (
                <span class="inline-block rounded-full bg-pink-100 px-3 py-1 text-sm text-pink-800">
                  {keyword}
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Recommended Vehicles */}
        {content.recommendedVehicles && content.recommendedVehicles.length > 0 && (
          <div class="my-8 rounded-lg bg-rose-50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Recommended Wedding Vehicles</h3>
            <div class="grid gap-3 sm:grid-cols-3">
              {content.recommendedVehicles.map((vehicle) => (
                <a href="/fleet" class="flex items-center gap-2 rounded-lg bg-white p-3 shadow-sm hover:shadow-md transition">
                  <span class="text-rose-600 text-xl">üöó</span>
                  <span class="font-medium text-gray-800">{vehicle}</span>
                </a>
              ))}
            </div>
            <p class="mt-3 text-sm text-gray-600">
              <a href="/fleet" class="text-rose-600 hover:underline">View our complete wedding fleet</a> for your special day.
            </p>
          </div>
        )}

        {/* Call-to-Action */}
        <div class="my-8 rounded-lg border-2 border-rose-600 bg-rose-50 p-6 text-center">
          <h3 class="mb-2 text-2xl font-bold text-rose-900">Make Your Wedding Day Perfect</h3>
          <p class="mb-4 text-rose-800">Elegant wedding transportation in Chicago and suburbs</p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="/booking"
              class="inline-block rounded-lg bg-rose-600 px-8 py-3 font-semibold text-white hover:bg-rose-700"
            >
              Book Your Wedding Transportation
            </a>
            <a
              href="tel:+12248013090"
              class="inline-block rounded-lg border-2 border-rose-600 px-8 py-3 font-semibold text-rose-600 hover:bg-rose-100"
            >
              Call (224) 801-3090
            </a>
          </div>
        </div>

        {/* Cross-Sell Other Services */}
        {content.crossSellWebsites && content.crossSellWebsites.length > 0 && (
          <div class="my-8 rounded-lg border border-gray-200 bg-white p-6">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Related Services for Your Wedding</h3>
            <div class="grid gap-4 sm:grid-cols-2">
              {content.crossSellWebsites.includes('chicago-partybus') && (
                <a href="https://chicago-partybus.com" target="_blank" rel="noopener" class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 hover:bg-gray-100 transition">
                  <span class="text-2xl">üéâ</span>
                  <div>
                    <h4 class="font-semibold text-gray-900">Party Bus Rentals</h4>
                    <p class="text-sm text-gray-600">Perfect for bachelor/bachelorette parties!</p>
                  </div>
                </a>
              )}
              {content.crossSellWebsites.includes('chicagoairportblackcar') && (
                <a href="https://chicagoairportblackcar.com" target="_blank" rel="noopener" class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 hover:bg-gray-100 transition">
                  <span class="text-2xl">‚úàÔ∏è</span>
                  <div>
                    <h4 class="font-semibold text-gray-900">Airport Transfers</h4>
                    <p class="text-sm text-gray-600">Transportation for out-of-town wedding guests</p>
                  </div>
                </a>
              )}
              {content.crossSellWebsites.includes('chicagoexecutivecarservice') && (
                <a href="https://chicagoexecutivecarservice.com" target="_blank" rel="noopener" class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 hover:bg-gray-100 transition">
                  <span class="text-2xl">üíº</span>
                  <div>
                    <h4 class="font-semibold text-gray-900">Executive Car Service</h4>
                    <p class="text-sm text-gray-600">Professional transport for rehearsal dinners</p>
                  </div>
                </a>
              )}
            </div>
          </div>
        )}

        {/* Internal Links Section */}
        {content.internalLinks && content.internalLinks.length > 0 && (
          <div class="my-8 rounded-lg bg-gray-100 p-6">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Other Wedding Services</h3>
            <div class="grid gap-4 md:grid-cols-2">
              {content.internalLinks.slice(0, 6).map((link) => (
                <a
                  href={link.url}
                  class="block rounded-lg bg-white p-4 hover:shadow-lg transition"
                >
                  <h4 class="font-semibold text-pink-600 hover:underline">{link.title}</h4>
                  <p class="mt-1 text-sm text-gray-600">{link.context}</p>
                </a>
              ))}
            </div>
          </div>
        )}
      </article>

      {/* JSON-LD Schema Markup */}
      {content.schema && (
        <script type="application/ld+json" set:html={JSON.stringify(content.schema)} />
      )}
    </div>
  </div>
</BaseLayout>
