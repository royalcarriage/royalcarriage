---
import BaseLayout from '../layouts/BaseLayout.astro';
import CTAButton from '@packages/astro-components/CTAButton.astro';
import CallButton from '@packages/astro-components/CallButton.astro';
import { generateServiceSchema } from '@packages/astro-utils/schema';
import { getSiteConfig } from '@packages/astro-utils/config';
import { db } from '../lib/firebase';
import { collection, getDocs, query, where } from 'firebase/firestore';

const config = getSiteConfig('wedding');

interface Location {
  id: string;
  name: string;
  slug: string;
  type: string;
  area?: string;
  region?: string;
}

interface ServiceContent {
  locationId: string;
  serviceId: string;
  serviceName: string;
}

let locations: Location[] = [];
let contentByLocation: Record<string, ServiceContent[]> = {};

try {
  if (db) {
    const locSnap = await getDocs(collection(db, 'locations'));
    locations = locSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    })) as Location[];

    const contentQuery = query(
      collection(db, 'service_content'),
      where('websiteId', '==', 'chicagoweddingtransportation'),
      where('approvalStatus', '==', 'approved')
    );
    const contentSnap = await getDocs(contentQuery);

    contentSnap.docs.forEach(doc => {
      const data = doc.data();
      const locId = data.locationId;
      if (!contentByLocation[locId]) {
        contentByLocation[locId] = [];
      }
      contentByLocation[locId].push({
        locationId: data.locationId,
        serviceId: data.serviceId,
        serviceName: data.serviceName
      });
    });
  }
} catch (error) {
  console.warn('[Locations] Error fetching data:', error);
}

const locationsByArea: Record<string, Location[]> = {};
locations.forEach(loc => {
  const area = loc.area || loc.region || 'Other Areas';
  if (!locationsByArea[area]) {
    locationsByArea[area] = [];
  }
  locationsByArea[area].push(loc);
});

const sortedAreas = Object.keys(locationsByArea).sort();
sortedAreas.forEach(area => {
  locationsByArea[area].sort((a, b) => a.name.localeCompare(b.name));
});

const areaNames: Record<string, string> = {
  'north': 'North & Northwest Suburbs',
  'north-suburbs': 'North Suburbs',
  'north-side': 'North Side Chicago',
  'south': 'South & Southwest Suburbs',
  'south-suburbs': 'South Suburbs',
  'south-side': 'South Side Chicago',
  'southwest': 'Southwest Suburbs',
  'west': 'Western Suburbs',
  'west-suburbs': 'Western Suburbs',
  'near-west': 'Near West Side',
  'downtown': 'Downtown Chicago',
  'Other Areas': 'Other Service Areas'
};

const serviceSchema = generateServiceSchema({
  config,
  serviceName: "Chicago Wedding Transportation Service Areas",
  serviceDescription: "Wedding limousine service throughout Chicago and suburbs. Elegant transportation for weddings in Naperville, Oak Brook, Hinsdale, and 200+ venue locations.",
  serviceType: "Wedding Transportation",
  url: Astro.url.pathname
});
---

<BaseLayout
  title="Wedding Transportation Service Areas - Chicago & Suburbs"
  description="Wedding limousine service throughout Chicago and suburbs. Elegant transportation for weddings in Naperville, Oak Brook, Hinsdale, and 200+ venue locations."
  canonical="/locations"
  schema={serviceSchema}
>
  <div class="bg-gradient-to-r from-rose-900 to-rose-700 text-white py-16">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Wedding Transportation Service Areas</h1>
      <p class="text-xl text-rose-200 mb-6">Elegant wedding limousines serving {locations.length}+ Chicago venues</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <CTAButton target="wedding" location="hero" size="lg" />
        <CallButton target="wedding" location="hero" size="lg" />
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-12">
    <div class="max-w-6xl mx-auto">
      <p class="text-lg text-gray-700 mb-8">
        Royal Carriage provides elegant wedding transportation throughout the Chicago area.
        We serve wedding venues, churches, hotels, and reception halls in these locations.
      </p>

      {sortedAreas.map(area => (
        <div class="mb-10">
          <h2 class="text-2xl font-bold mb-4 text-gray-900 border-b-2 border-rose-600 pb-2">
            {areaNames[area] || area.charAt(0).toUpperCase() + area.slice(1).replace(/-/g, ' ')}
          </h2>
          <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {locationsByArea[area].map(loc => {
              const services = contentByLocation[loc.slug] || contentByLocation[loc.id] || [];
              const hasServices = services.length > 0;
              const firstService = services[0];

              return hasServices ? (
                <a
                  href={`/service/${loc.slug || loc.id}/${firstService.serviceId}`}
                  class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-rose-500 transition group"
                >
                  <div class="font-semibold text-gray-900 group-hover:text-rose-600">{loc.name}</div>
                  <div class="text-sm text-gray-500 mt-1">{services.length} service{services.length !== 1 ? 's' : ''} available</div>
                </a>
              ) : (
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="font-semibold text-gray-700">{loc.name}</div>
                  <div class="text-sm text-gray-400 mt-1">Coming soon</div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>

  <div class="bg-rose-50 py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-6 text-center">Wedding Services Available</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-rose-800">Popular Wedding Venues</h3>
            <ul class="space-y-2 text-gray-700">
              <li>Downtown Chicago Hotels</li>
              <li>North Shore Estates</li>
              <li>Western Suburbs Country Clubs</li>
              <li>Historic Churches & Cathedrals</li>
            </ul>
          </div>
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-rose-800">Wedding Services</h3>
            <ul class="space-y-2 text-gray-700">
              <li>Bride & Groom Transportation</li>
              <li>Bridal Party Limousines</li>
              <li>Guest Shuttle Services</li>
              <li>Airport Transfers for Guests</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-rose-900 text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Book Your Wedding Transportation</h2>
      <p class="text-xl text-rose-200 mb-6">Make your special day unforgettable</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <CTAButton target="wedding" location="bottom-cta" size="lg" variant="secondary" />
        <CallButton target="wedding" location="bottom-cta" size="lg" />
      </div>
    </div>
  </div>
</BaseLayout>
