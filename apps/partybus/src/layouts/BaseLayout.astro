---
import '../styles/globals.css';
import Header from '@packages/astro-components/Header.astro';
import NavBar from '@packages/astro-components/NavBar.astro';
import Footer from '@packages/astro-components/Footer.astro';
import { getSiteConfig } from '@packages/astro-utils/config';
import { generateMetaTags } from '@packages/astro-utils/seo';
import { generateLocalBusinessSchema } from '@packages/astro-utils/schema';

interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  schema?: any;
  noindex?: boolean;
}

const { title, description, canonical, ogImage, schema, noindex = false } = Astro.props;

const config = getSiteConfig('partybus');
const metaTags = generateMetaTags({
  title: `${title} | ${config.name}`,
  description,
  canonical: canonical || Astro.url.pathname,
  ogImage,
  noindex
});

const businessSchema = generateLocalBusinessSchema({
  config,
  url: Astro.url.pathname
});

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/party-bus-rental', label: 'Party Bus' },
  { href: '/birthday-party-bus', label: 'Birthday Parties' },
  { href: '/concert-transportation', label: 'Concerts' },
  { href: '/fleet', label: 'Fleet' },
  { href: '/contact', label: 'Contact' }
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Redirect .web.app/.firebaseapp.com to custom domain -->
  <script is:inline define:vars={{ productionDomain: config.domain }}>
    (function() {
      var host = window.location.hostname;
      if (host.endsWith('.web.app') || host.endsWith('.firebaseapp.com')) {
        window.location.replace(productionDomain + window.location.pathname + window.location.search);
      }
    })();
  </script>

  <title>{metaTags.title}</title>
  <meta name="description" content={metaTags.description}>
  <meta name="robots" content={metaTags.robots}>
  <link rel="canonical" href={`${config.domain}${canonical || Astro.url.pathname}`}>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content={metaTags.title}>
  <meta property="og:description" content={metaTags.description}>
  <meta property="og:url" content={`${config.domain}${Astro.url.pathname}`}>
  <meta property="og:image" content={metaTags.ogImage}>

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={metaTags.title}>
  <meta name="twitter:description" content={metaTags.description}>
  <meta name="twitter:image" content={metaTags.ogImage}>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(businessSchema)}></script>
  {schema && <script type="application/ld+json" set:html={JSON.stringify(schema)}></script>}

  <!-- Google Analytics & Comprehensive Tracking -->
  {config.analytics?.googleAnalyticsId && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${config.analytics.googleAnalyticsId}`}></script>
      <script is:inline define:vars={{
        gaId: config.analytics.googleAnalyticsId,
        siteTarget: config.target,
        siteDomain: config.domain
      }}>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', gaId, {
          'page_title': document.title,
          'page_location': window.location.href,
          'page_path': window.location.pathname,
          'content_group': siteTarget,
          'send_page_view': true
        });

        gtag('set', 'user_properties', {
          site_target: siteTarget,
          user_type: 'visitor',
          referrer_domain: document.referrer ? new URL(document.referrer).hostname : 'direct'
        });

        var pageType = 'homepage';
        var path = window.location.pathname;
        if (path.includes('/service/')) pageType = 'service_page';
        else if (path.includes('/locations')) pageType = 'location_page';
        else if (path.includes('/fleet')) pageType = 'fleet_page';
        else if (path.includes('/contact')) pageType = 'contact_page';
        else if (path !== '/') pageType = 'landing_page';

        gtag('event', 'page_classification', { page_type: pageType, site_target: siteTarget });

        // Scroll Depth Tracking
        var scrollMarks = [25, 50, 75, 90, 100];
        var scrollFired = {};
        function trackScrollDepth() {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          var docHeight = document.documentElement.scrollHeight - window.innerHeight;
          var scrollPercent = Math.round((scrollTop / docHeight) * 100);
          scrollMarks.forEach(function(mark) {
            if (scrollPercent >= mark && !scrollFired[mark]) {
              scrollFired[mark] = true;
              gtag('event', 'scroll_depth', { event_category: 'engagement', event_label: mark + '%', value: mark, page_type: pageType });
            }
          });
        }
        window.addEventListener('scroll', trackScrollDepth, {passive: true});

        // Time on Page Tracking
        var pageStartTime = Date.now();
        var timeMarks = [10, 30, 60, 120, 300];
        var timeFired = {};
        setInterval(function() {
          var elapsed = Math.floor((Date.now() - pageStartTime) / 1000);
          timeMarks.forEach(function(mark) {
            if (elapsed >= mark && !timeFired[mark]) {
              timeFired[mark] = true;
              gtag('event', 'time_on_page', { event_category: 'engagement', event_label: mark + 's', value: mark, page_type: pageType });
            }
          });
        }, 5000);

        window.trackMoovsClick = function(action, label, value) {
          gtag('event', 'moovs_booking', { event_category: 'conversion', event_action: action, event_label: label || siteTarget, value: value || 100, currency: 'USD' });
          gtag('event', 'conversion', { send_to: gaId, event_category: 'booking', value: value || 100, currency: 'USD' });
        };

        window.trackPhoneCall = function(location) {
          gtag('event', 'phone_call', { event_category: 'contact', event_action: 'call_click', event_label: location || path, value: 50 });
          gtag('event', 'conversion', { send_to: gaId, event_category: 'phone_call', value: 50, currency: 'USD' });
        };

        window.trackFormSubmit = function(formType) {
          gtag('event', 'form_submit', { event_category: 'lead', event_action: 'form_submission', event_label: formType || 'contact', value: 25 });
          gtag('event', 'generate_lead', { currency: 'USD', value: 25 });
        };

        document.addEventListener('click', function(e) {
          var link = e.target.closest('a[href*="moovs.app"]');
          if (link) window.trackMoovsClick('booking_click', link.href);
          var phoneLink = e.target.closest('a[href^="tel:"]');
          if (phoneLink) window.trackPhoneCall(path);
          var emailLink = e.target.closest('a[href^="mailto:"]');
          if (emailLink) gtag('event', 'email_click', { event_category: 'contact', page_path: path });
          var extLink = e.target.closest('a[href^="http"]');
          if (extLink && !extLink.href.includes(siteDomain)) gtag('event', 'outbound_click', { event_category: 'outbound', event_label: extLink.href });
        });

        document.addEventListener('mouseleave', function(e) {
          if (e.clientY < 10) {
            var timeOnPage = Math.floor((Date.now() - pageStartTime) / 1000);
            gtag('event', 'exit_intent', { event_category: 'engagement', time_on_page: timeOnPage, page_type: pageType });
          }
        });

        console.log('[Analytics] Royal Carriage tracking initialized for', siteTarget);
      </script>
    </>
  )}
</head>
<body class="flex flex-col min-h-screen">
  <Header target="partybus" />
  <NavBar target="partybus" siteName="Party Bus Rental" navLinks={navLinks} />

  <main class="flex-grow">
    <slot />
  </main>

  <Footer target="partybus" siteName="Party Bus Rental" navLinks={navLinks} socialMedia={config.socialMedia} />
</body>
</html>
