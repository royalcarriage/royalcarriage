---
import BaseLayout from '../layouts/BaseLayout.astro';
import CTAButton from '@packages/astro-components/CTAButton.astro';
import CallButton from '@packages/astro-components/CallButton.astro';
import { generateServiceSchema } from '@packages/astro-utils/schema';
import { getSiteConfig } from '@packages/astro-utils/config';
import { db } from '../lib/firebase';
import { collection, getDocs, query, where } from 'firebase/firestore';

const config = getSiteConfig('airport');

// Fetch all locations from Firestore
interface Location {
  id: string;
  name: string;
  slug: string;
  type: string;
  area?: string;
  region?: string;
}

interface ServiceContent {
  locationId: string;
  serviceId: string;
  serviceName: string;
}

let locations: Location[] = [];
let contentByLocation: Record<string, ServiceContent[]> = {};

try {
  if (db) {
    // Fetch locations
    const locSnap = await getDocs(collection(db, 'locations'));
    locations = locSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    })) as Location[];

    // Fetch service content for this website to know which services are available
    const contentQuery = query(
      collection(db, 'service_content'),
      where('websiteId', '==', 'chicagoairportblackcar'),
      where('approvalStatus', '==', 'approved')
    );
    const contentSnap = await getDocs(contentQuery);

    contentSnap.docs.forEach(doc => {
      const data = doc.data();
      const locId = data.locationId;
      if (!contentByLocation[locId]) {
        contentByLocation[locId] = [];
      }
      contentByLocation[locId].push({
        locationId: data.locationId,
        serviceId: data.serviceId,
        serviceName: data.serviceName
      });
    });
  }
} catch (error) {
  console.warn('[Locations] Error fetching data:', error);
}

// Group locations by area
const locationsByArea: Record<string, Location[]> = {};
locations.forEach(loc => {
  const area = loc.area || loc.region || 'Other Areas';
  if (!locationsByArea[area]) {
    locationsByArea[area] = [];
  }
  locationsByArea[area].push(loc);
});

// Sort areas and locations
const sortedAreas = Object.keys(locationsByArea).sort();
sortedAreas.forEach(area => {
  locationsByArea[area].sort((a, b) => a.name.localeCompare(b.name));
});

// Friendly area names
const areaNames: Record<string, string> = {
  'north': 'North & Northwest Suburbs',
  'north-suburbs': 'North Suburbs',
  'north-side': 'North Side Chicago',
  'south': 'South & Southwest Suburbs',
  'south-suburbs': 'South Suburbs',
  'south-side': 'South Side Chicago',
  'southwest': 'Southwest Suburbs',
  'west': 'Western Suburbs',
  'west-suburbs': 'Western Suburbs',
  'near-west': 'Near West Side',
  'downtown': 'Downtown Chicago',
  'Other Areas': 'Other Service Areas'
};

const serviceSchema = generateServiceSchema({
  config,
  serviceName: "Chicago Airport Limousine Service Areas",
  serviceDescription: "Airport limousine service throughout Chicago and suburbs. Professional car service from O'Hare and Midway to Naperville, Schaumburg, Evanston, and 200+ locations.",
  serviceType: "Airport Transportation",
  url: Astro.url.pathname
});
---

<BaseLayout
  title="Chicago Airport Limo Service Areas - All Suburbs & Neighborhoods"
  description="Airport limousine service throughout Chicago and suburbs. Professional car service from O'Hare and Midway to Naperville, Schaumburg, Evanston, and 200+ locations."
  canonical="/locations"
  schema={serviceSchema}
>
  <!-- Hero Section -->
  <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white py-16">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Airport Limousine Service Areas</h1>
      <p class="text-xl text-blue-100 mb-6">Professional airport transportation to {locations.length}+ Chicago locations</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <CTAButton target="airport" location="hero" size="lg" />
        <CallButton target="airport" location="hero" size="lg" />
      </div>
    </div>
  </div>

  <!-- Location Grid -->
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-6xl mx-auto">
      <p class="text-lg text-gray-700 mb-8">
        Royal Carriage Limousine provides reliable airport transportation throughout the Chicago metropolitan area.
        Click on any location below to see available services and book your ride.
      </p>

      {sortedAreas.map(area => (
        <div class="mb-10">
          <h2 class="text-2xl font-bold mb-4 text-gray-900 border-b-2 border-blue-600 pb-2">
            {areaNames[area] || area.charAt(0).toUpperCase() + area.slice(1).replace(/-/g, ' ')}
          </h2>
          <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {locationsByArea[area].map(loc => {
              const services = contentByLocation[loc.slug] || contentByLocation[loc.id] || [];
              const hasServices = services.length > 0;
              const firstService = services[0];

              return hasServices ? (
                <a
                  href={`/service/${loc.slug || loc.id}/${firstService.serviceId}`}
                  class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-blue-500 transition group"
                >
                  <div class="font-semibold text-gray-900 group-hover:text-blue-600">{loc.name}</div>
                  <div class="text-sm text-gray-500 mt-1">{services.length} service{services.length !== 1 ? 's' : ''} available</div>
                </a>
              ) : (
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="font-semibold text-gray-700">{loc.name}</div>
                  <div class="text-sm text-gray-400 mt-1">Coming soon</div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Service Types -->
  <div class="bg-gray-100 py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-6 text-center">Airport Services Available</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-blue-800">O'Hare Airport (ORD)</h3>
            <ul class="space-y-2 text-gray-700">
              <li>Domestic & International Terminal Pickup</li>
              <li>Meet & Greet Service Available</li>
              <li>Flight Tracking & Monitoring</li>
              <li>Curbside or Inside Terminal Pickup</li>
            </ul>
          </div>
          <div class="bg-white rounded-lg p-6 shadow">
            <h3 class="text-xl font-bold mb-3 text-blue-800">Midway Airport (MDW)</h3>
            <ul class="space-y-2 text-gray-700">
              <li>All Airlines & Terminals Served</li>
              <li>Convenient Pickup Locations</li>
              <li>Real-Time Flight Monitoring</li>
              <li>Southwest Airlines Specialist</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CTA Section -->
  <div class="bg-blue-900 text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Book Your Airport Transportation</h2>
      <p class="text-xl text-blue-200 mb-6">Available 24/7 for all Chicago area pickups</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <CTAButton target="airport" location="bottom-cta" size="lg" variant="secondary" />
        <CallButton target="airport" location="bottom-cta" size="lg" />
      </div>
    </div>
  </div>
</BaseLayout>
