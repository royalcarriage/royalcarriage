rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================================
    // HELPER FUNCTIONS
    // ===========================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getRole() {
      return request.auth.token.role != null ? request.auth.token.role : 'viewer';
    }

    function getUserOrgId() {
      return request.auth.token.organizationId != null ? request.auth.token.organizationId : null;
    }

    function hasRole(role) {
      return isAuthenticated() && getRole() == role;
    }

    // ===========================================
    // ROLE HIERARCHY (Multi-Organization)
    // ===========================================

    // SaaS Admin - Can view/manage everything across all organizations
    function isSaasAdmin() {
      return hasRole('saas_admin') || hasRole('superadmin');
    }

    // Admin - Full access within their organization
    function isAdmin() {
      return isSaasAdmin() || hasRole('admin');
    }

    // Fleet Manager - Manage drivers, vehicles, issues, deductions
    function isFleetManager() {
      return isAdmin() || hasRole('fleet_manager');
    }

    // Accountant - Import CSV, view accounting, receipts, refunds
    function isAccountant() {
      return isAdmin() || hasRole('accountant');
    }

    // Dispatcher - View vehicles, drivers, assignments, issues
    function isDispatcher() {
      return isAdmin() || hasRole('dispatcher');
    }

    // Editor - Content editing (legacy)
    function isEditor() {
      return isAdmin() || hasRole('editor');
    }

    // Viewer - Read-only access (legacy)
    function isViewer() {
      return isEditor() || hasRole('viewer') || isDispatcher() || isAccountant() || isFleetManager();
    }

    // ===========================================
    // ORGANIZATION ACCESS CONTROL
    // ===========================================

    function belongsToOrganization(orgId) {
      return isSaasAdmin() || getUserOrgId() == orgId;
    }

    function canAccessResourceOrg(resourceOrgId) {
      return isSaasAdmin() || (resourceOrgId == null) || (getUserOrgId() == resourceOrgId);
    }

    // ===========================================
    // ORGANIZATIONS COLLECTION
    // ===========================================

    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (isSaasAdmin() || belongsToOrganization(orgId));
      allow create: if isSaasAdmin();
      allow update: if isSaasAdmin() || (isAdmin() && belongsToOrganization(orgId));
      allow delete: if isSaasAdmin();
    }

    // ===========================================
    // USERS COLLECTION (Multi-Org)
    // ===========================================

    match /users/{userId} {
      // Users can read their own profile, admins can read users in their org, saas_admin can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSaasAdmin() ||
        (isAdmin() && canAccessResourceOrg(resource.data.organizationId))
      );
      // Users can create their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Admins can update users in their org (except role), saas_admin can update any
      allow update: if isSaasAdmin() || (
        isAdmin() &&
        canAccessResourceOrg(resource.data.organizationId) &&
        request.resource.data.role == resource.data.role
      );
      allow delete: if isSaasAdmin();
    }

    // ===========================================
    // VEHICLES COLLECTION (Dispatcher, Fleet Manager, Admin)
    // ===========================================

    match /vehicles/{vehicleId} {
      allow read: if isAuthenticated() && (
        isSaasAdmin() ||
        isDispatcher() ||
        isFleetManager() ||
        isAdmin()
      ) && canAccessResourceOrg(resource.data.organizationId);
      allow create, update: if isAuthenticated() && (
        isSaasAdmin() ||
        isFleetManager() ||
        isAdmin()
      ) && canAccessResourceOrg(request.resource.data.organizationId);
      allow delete: if isSaasAdmin() || isAdmin();
    }

    match /fleet_vehicles/{vehicleId} {
      // Public read for static site generation (fleet pages)
      allow read: if true;
      allow write: if isFleetManager() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // DRIVERS COLLECTION (Dispatcher, Fleet Manager, Admin)
    // ===========================================

    match /drivers/{driverId} {
      allow read: if isAuthenticated() && (
        isDispatcher() ||
        isFleetManager() ||
        isAccountant() ||
        isAdmin() ||
        isSaasAdmin()
      ) && canAccessResourceOrg(resource.data.organizationId);
      allow create, update: if isAuthenticated() && (
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      ) && canAccessResourceOrg(request.resource.data.organizationId);
      allow delete: if isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // VEHICLE ASSIGNMENTS (Dispatcher, Fleet Manager)
    // ===========================================

    match /vehicle_assignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        isDispatcher() ||
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow write: if isFleetManager() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // VEHICLE ISSUES (Dispatcher can view, Fleet Manager can manage)
    // ===========================================

    match /vehicle_issues/{issueId} {
      allow read: if isAuthenticated() && (
        isDispatcher() ||
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow create: if isDispatcher() || isFleetManager() || isAdmin() || isSaasAdmin();
      allow update, delete: if isFleetManager() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // ACCOUNTING & FINANCIAL (Accountant, Admin)
    // ===========================================

    match /accounting/{docId} {
      allow read: if isAuthenticated() && (
        isAccountant() ||
        isAdmin() ||
        isSaasAdmin()
      ) && canAccessResourceOrg(resource.data.organizationId);
      allow write: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        isAccountant() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow write: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (isAccountant() || isAdmin() || isSaasAdmin());
      allow write: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // RECEIPTS (Accountant can view/upload)
    // ===========================================

    match /receipts/{receiptId} {
      allow read: if isAuthenticated() && (
        isAccountant() ||
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow create: if isAccountant() || isFleetManager() || isAdmin() || isSaasAdmin();
      allow update, delete: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // REFUNDS (Accountant can report)
    // ===========================================

    match /refunds/{refundId} {
      allow read: if isAuthenticated() && (isAccountant() || isAdmin() || isSaasAdmin());
      allow create, update: if isAccountant() || isAdmin() || isSaasAdmin();
      allow delete: if isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // PAYROLL & DEDUCTIONS (Fleet Manager, Admin)
    // ===========================================

    match /payroll/{payrollId} {
      allow read: if isAuthenticated() && (
        isAccountant() ||
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow write: if isFleetManager() || isAdmin() || isSaasAdmin();
    }

    match /deductions/{deductionId} {
      allow read: if isAuthenticated() && (
        isAccountant() ||
        isFleetManager() ||
        isAdmin() ||
        isSaasAdmin()
      );
      allow create, update: if isFleetManager() || isAdmin() || isSaasAdmin();
      allow delete: if isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // CSV IMPORTS (Accountant, Admin)
    // ===========================================

    match /imports/{importId} {
      allow read: if isAccountant() || isAdmin() || isSaasAdmin();
      allow write: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    match /ads_metrics/{metricId} {
      allow read: if isAccountant() || isAdmin() || isSaasAdmin();
      allow write: if isAccountant() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // AI CHAT MESSAGES & HISTORY (Role-filtered)
    // ===========================================

    match /ai_chat_sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSaasAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSaasAdmin()
      );
      allow delete: if isSaasAdmin();
    }

    match /ai_chat_messages/{messageId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ===========================================
    // EXISTING SEO/CONTENT COLLECTIONS
    // ===========================================

    match /settings/{settingId} {
      allow read: if isViewer();
      allow write: if isSaasAdmin();
    }

    match /metrics/{metricId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }

    match /seo_bot/{taskId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }

    match /images/{imageId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }

    match /deploy_logs/{logId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }

    match /reports/{reportId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }

    match /service_content/{contentId} {
      // Public read for static site generation
      allow read: if true;
      allow create, update: if isAdmin() || isSaasAdmin() || request.auth.token.role == 'api';
      allow delete: if isSaasAdmin();
    }

    match /content_quality_scores/{contentId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin() || request.auth.token.role == 'api';
    }

    match /regeneration_queue/{taskId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow write: if isAdmin() || isSaasAdmin() || request.auth.token.role == 'api';
    }

    match /regeneration_logs/{logId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow write: if request.auth.token.role == 'api';
    }

    match /content_regeneration_history/{historyId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow write: if request.auth.token.role == 'api';
    }

    match /competitor_analysis/{analysisId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow write: if isAdmin() || isSaasAdmin() || request.auth.token.role == 'api';
    }

    match /locations/{locationId} {
      // Public read for static site generation
      allow read: if true;
      allow write: if isAdmin() || isSaasAdmin();
    }

    match /services/{serviceId} {
      // Public read for static site generation
      allow read: if true;
      allow write: if isAdmin() || isSaasAdmin();
    }

    // Legacy support
    match /page_analyses/{id} { allow read: if isViewer(); allow write: if isAdmin() || isSaasAdmin(); }
    match /content_suggestions/{id} { allow read: if isViewer(); allow write: if isEditor(); }
    match /ai_images/{id} { allow read: if isViewer(); allow write: if isEditor(); }

    // ===========================================
    // ACTIVITY LOGS (Audit Trail)
    // ===========================================

    match /activity_logs/{logId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isSaasAdmin();
    }

    match /activity_log/{logId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isSaasAdmin();
    }

    // ===========================================
    // BLOG POSTS (Public Read)
    // ===========================================

    match /blog_posts/{postId} {
      // Public read for blog pages
      allow read: if true;
      allow write: if isEditor() || isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // TENANTS
    // ===========================================

    match /tenants/{tenantId} {
      allow read: if isAuthenticated();
      allow write: if isSaasAdmin();
    }

    // ===========================================
    // AUDIT LOGS
    // ===========================================

    match /auditLogs/{logId} {
      allow read: if isAdmin() || isSaasAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isSaasAdmin();
    }

    // ===========================================
    // SEO COLLECTIONS
    // ===========================================

    match /seo-reports/{reportId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }

    match /seo-tasks/{taskId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }

    // ===========================================
    // SCHEDULES (Content Generation)
    // ===========================================

    match /schedules/{scheduleId} {
      allow read: if isViewer();
      allow write: if isAdmin() || isSaasAdmin();
    }
  }
}
