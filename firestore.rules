rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check user role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Helper function to check if user has minimum role
    function hasMinimumRole(role) {
      let userRole = getUserData().role;
      let roleHierarchy = {
        'SuperAdmin': 4,
        'Admin': 3,
        'Editor': 2,
        'Viewer': 1
      };
      return isAuthenticated() && 
             roleHierarchy[userRole] >= roleHierarchy[role];
    }
    
    // Helper function to check if user is SuperAdmin
    function isSuperAdmin() {
      return hasRole('SuperAdmin');
    }
    
    // Helper function to check if user is Admin or higher
    function isAdmin() {
      return hasMinimumRole('Admin');
    }
    
    // Helper function to check if user is Editor or higher
    function isEditor() {
      return hasMinimumRole('Editor');
    }
    
    // Helper function to check if user is authenticated (Viewer or higher)
    function isViewer() {
      return hasMinimumRole('Viewer');
    }
    
    // Helper function to check image generation rate limit
    function canGenerateImage() {
      let today = request.time.toMillis() - (request.time.toMillis() % 86400000); // 86400000 ms = 1 day
      let usageStatsPath = /databases/$(database)/documents/usage_stats/$(request.auth.uid + '_' + today);
      
      // Rate limit: matches MAX_IMAGES_PER_DAY environment variable (default 50)
      let maxImagesPerDay = 50;
      
      return isAdmin() && (
        !exists(usageStatsPath) ||
        get(usageStatsPath).data.imageGenerations < maxImagesPerDay
      );
    }
    
    // Helper function to validate image data
    function isValidImageData() {
      return request.resource.data.keys().hasAll(['imageUrl', 'purpose', 'prompt', 'createdAt', 'createdBy']) &&
             request.resource.data.purpose in ['hero', 'service_card', 'fleet', 'location', 'testimonial'] &&
             request.resource.data.imageUrl is string &&
             request.resource.data.prompt is string &&
             request.resource.data.createdBy == request.auth.uid;
    }
    
    // Users collection - role-based access
    match /users/{userId} {
      // Users can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Admins can read all users
      allow read: if isAdmin();
      // Users can update their own profile (but not role)
      allow update: if isAuthenticated() && 
                      request.auth.uid == userId && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      // Only SuperAdmin and Admin can manage user roles
      allow write: if isSuperAdmin() || isAdmin();
    }
    
    // Page analyses - Editor or higher can write, Viewer can read
    match /page_analyses/{analysisId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }
    
    // Content suggestions - Editor or higher
    match /content_suggestions/{suggestionId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }
    
    // AI images - admin only with validation
    match /ai_images/{imageId} {
      allow read: if isViewer();
      
      // Create: admin only, must pass validation and rate limit
      allow create: if isAdmin() && 
                      canGenerateImage() &&
                      isValidImageData();
      
      // Update: admin only, can only update status and approval fields
      allow update: if isAdmin() && 
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['status', 'approvedAt', 'approvedBy', 'updatedAt']);
      
      // Delete: soft delete only via status field, no hard deletes
      allow delete: if false;
    }
    
    // Usage statistics - system managed, admin read-only
    match /usage_stats/{statId} {
      allow read: if isAdmin();
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Audit logs - read only for admins
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only system can write
    }
    
    // Scheduled jobs - admin only
    match /scheduled_jobs/{jobId} {
      allow read: if isViewer();
      allow write: if isAdmin();
    }
    
    // AI settings - admin only
    match /ai_settings/{settingId} {
      allow read: if isViewer();
      allow write: if isAdmin();
    }
    
    // SEO reports - viewer can read, editor can write
    match /seo_reports/{reportId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }
    
    // Pages - viewer can read, editor can write
    match /pages/{pageId} {
      allow read: if isViewer();
      allow write: if isEditor();
    }
    
    // CSV imports - admin only
    match /csv_imports/{importId} {
      allow read: if isViewer();
      allow write: if isAdmin();
    }
    
    // Analytics data - viewer can read, admin can write
    match /analytics/{docId} {
      allow read: if isViewer();
      allow write: if isAdmin();
    }
    
    // Settings - admin only
    match /settings/{settingId} {
      allow read: if isViewer();
      allow write: if isAdmin();
    }
  }
}
