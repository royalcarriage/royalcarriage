rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check image generation rate limit
    function canGenerateImage() {
      let today = request.time.toMillis() - (request.time.toMillis() % 86400000); // 86400000 ms = 1 day
      let usageStatsPath = /databases/$(database)/documents/usage_stats/$(request.auth.uid + '_' + today);
      
      // Rate limit: matches MAX_IMAGES_PER_DAY environment variable (default 50)
      let maxImagesPerDay = 50;
      
      return isAdmin() && (
        !exists(usageStatsPath) ||
        get(usageStatsPath).data.imageGenerations < maxImagesPerDay
      );
    }
    
    // Helper function to validate image data
    function isValidImageData() {
      return request.resource.data.keys().hasAll(['imageUrl', 'purpose', 'prompt', 'createdAt', 'createdBy']) &&
             request.resource.data.purpose in ['hero', 'service_card', 'fleet', 'location', 'testimonial'] &&
             request.resource.data.imageUrl is string &&
             request.resource.data.prompt is string &&
             request.resource.data.createdBy == request.auth.uid;
    }
    
    // Users collection - only admins can read/write
    match /users/{userId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Page analyses - admin only
    match /page_analyses/{analysisId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Content suggestions - admin only
    match /content_suggestions/{suggestionId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AI images - admin only with validation
    match /ai_images/{imageId} {
      allow read: if isAdmin();
      
      // Create: admin only, must pass validation and rate limit
      allow create: if isAdmin() && 
                      canGenerateImage() &&
                      isValidImageData();
      
      // Update: admin only, can only update status and approval fields
      allow update: if isAdmin() && 
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['status', 'approvedAt', 'approvedBy', 'updatedAt']);
      
      // Delete: soft delete only via status field, no hard deletes
      allow delete: if false;
    }
    
    // Usage statistics - system managed, admin read-only
    match /usage_stats/{statId} {
      allow read: if isAdmin();
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Audit logs - read only for admins
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only system can write
    }
    
    // Scheduled jobs - admin only
    match /scheduled_jobs/{jobId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AI settings - admin only
    match /ai_settings/{settingId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // SEO reports - admin only
    match /seo_reports/{reportId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Pages - admin only
    match /pages/{pageId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // CSV Import System Collections
    
    // Raw import batches - admin only
    match /raw_import_batches/{batchId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() || request.auth.uid == 'firebase-functions'; // Functions can update
      allow delete: if false; // Immutable - never delete
    }
    
    // Raw import rows - admin read, functions write
    match /raw_import_rows/{rowId} {
      allow read: if isAdmin();
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Bookings - admin read/write
    match /bookings/{bookingId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false; // Soft delete only via status field
    }
    
    // Revenue lines - admin read/write
    match /revenue_lines/{lineId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    
    // Receivables - admin read/write
    match /receivables/{receivableId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    
    // Driver payouts - admin read/write
    match /driver_payouts/{payoutId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    
    // Affiliate payables - admin read/write
    match /affiliate_payables/{payableId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    
    // Fleet vehicles - admin read/write
    match /fleet/{vehicleId} {
      allow read: if isAdmin();
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    
    // Marketing data - admin read, functions write
    match /marketing_daily_ga4/{recordId} {
      allow read: if isAdmin();
      allow write: if false; // Only Firebase Functions can write
    }
    
    match /marketing_daily_google_ads/{recordId} {
      allow read: if isAdmin();
      allow write: if false; // Only Firebase Functions can write
    }
  }
}
