name: Build and Deploy to Firebase

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20.x'
  BUILD_ARTIFACT_NAME: build-output

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript check
        run: npm run check
      
      - name: Build application
        run: npm run build
      
      - name: Run enhanced smoke tests
        run: |
          echo "Running smoke tests..."
          
          # Check required files exist
          test -f dist/public/index.html || (echo "‚ùå Error: index.html not found" && exit 1)
          echo "‚úì index.html exists"
          
          test -f dist/index.cjs || (echo "‚ùå Error: server bundle not found" && exit 1)
          echo "‚úì server bundle exists"
          
          test -d dist/public/assets || (echo "‚ùå Error: assets directory not found" && exit 1)
          echo "‚úì assets directory exists"
          
          # Check HTML is valid (basic check)
          grep -q "<!DOCTYPE html>" dist/public/index.html || (echo "‚ùå Error: Invalid HTML" && exit 1)
          echo "‚úì HTML structure valid"
          
          # Check for common assets
          if find dist/public/assets -name "*.js" -type f | head -1 | grep -q .; then
            echo "‚úì JavaScript bundle exists"
          else
            echo "‚ùå Error: JavaScript bundle not found" && exit 1
          fi
          
          if find dist/public/assets -name "*.css" -type f | head -1 | grep -q .; then
            echo "‚úì CSS bundle exists"
          else
            echo "‚ùå Error: CSS bundle not found" && exit 1
          fi
          
          # Check bundle sizes
          JS_SIZE=$(find dist/public/assets -name "*.js" -type f -exec du -sb {} + | awk '{sum+=$1} END {print sum}')
          if [ "$JS_SIZE" -gt 1048576 ]; then
            JS_SIZE_MB=$((JS_SIZE / 1024 / 1024))
            echo "‚ö†Ô∏è Warning: JavaScript bundle is large (${JS_SIZE_MB}MB)"
          else
            echo "‚úì JavaScript bundle size acceptable"
          fi
          
          echo "‚úÖ All smoke tests passed"
      
      - name: Generate build report
        run: |
          echo "# Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Calculate sizes
          HTML_SIZE=$(du -h dist/public/index.html | cut -f1)
          SERVER_SIZE=$(du -h dist/index.cjs | cut -f1)
          ASSETS_SIZE=$(du -sh dist/public/assets | cut -f1)
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          
          echo "| index.html | $HTML_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| server bundle | $SERVER_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| assets/ | $ASSETS_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL_SIZE** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Build completed successfully" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT_NAME }}
          path: dist/
          retention-days: 7

  deploy-production:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://chicagoairportblackcar.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT_NAME }}
          path: dist/
      
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID || 'default' }}
        id: deploy-production
      
      - name: Create deployment summary
        run: |
          echo "# üöÄ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Successfully deployed to Firebase Hosting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** https://chicagoairportblackcar.com" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy-preview:
    name: Deploy Preview
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment:
      name: preview
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT_NAME }}
          path: dist/
      
      - name: Deploy to Firebase Hosting Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: ${{ secrets.FIREBASE_PROJECT_ID || 'default' }}
        id: deploy-preview
      
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.deploy-preview.outputs.details_url }}';
            const expireDate = new Date();
            expireDate.setDate(expireDate.getDate() + 7);
            
            const message = `## üöÄ Preview Deployment
            
            Your changes have been deployed to Firebase Hosting preview!
            
            ### üîó Preview URL
            ${previewUrl}
            
            ### üìã Build Information
            - **Commit:** ${context.sha.substring(0, 7)}
            - **Branch:** ${context.ref}
            - **Deployed:** ${new Date().toUTCString()}
            - **Expires:** ${expireDate.toUTCString()}
            
            ### ‚úÖ Deployment Status
            - Build: Success
            - Deploy: Success
            - Status: Ready for review
            
            *This preview will automatically expire in 7 days.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
