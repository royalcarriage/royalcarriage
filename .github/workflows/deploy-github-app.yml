name: Deploy via GitHub App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout (initial)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install JWT deps
        run: python -m pip install --upgrade pip && python -m pip install pyjwt[crypto] requests

      - name: Create JWT and request installation token
        env:
          GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}
          GITHUB_APP_INSTALLATION_ID: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}
        run: |
          python - <<'PY'
          import os, time, jwt, requests
          app_id = os.environ.get('GITHUB_APP_ID')
          private_key = os.environ.get('GITHUB_APP_PRIVATE_KEY')
          installation_id = os.environ.get('GITHUB_APP_INSTALLATION_ID')
          if not (app_id and private_key and installation_id):
              raise SystemExit('Missing one of GITHUB_APP_ID, GITHUB_APP_PRIVATE_KEY, GITHUB_APP_INSTALLATION_ID')
          now = int(time.time())
          payload = { 'iat': now - 60, 'exp': now + (10 * 60), 'iss': int(app_id) }
          token = jwt.encode(payload, private_key, algorithm='RS256')
          headers = { 'Authorization': f'Bearer {token}', 'Accept': 'application/vnd.github+json' }
          url = f'https://api.github.com/app/installations/{installation_id}/access_tokens'
          r = requests.post(url, headers=headers)
          r.raise_for_status()
          j = r.json()
          itoken = j['token']
          # mask and export
          print('::add-mask::' + itoken)
          with open(os.environ['GITHUB_ENV'], 'a') as fh:
              fh.write(f'INSTALLATION_TOKEN={itoken}\n')
          PY

      - name: Checkout using installation token
        uses: actions/checkout@v4
        with:
          token: ${{ env.INSTALLATION_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        run: npm install -g pnpm@8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build || true

      - name: Deploy (Firebase if token present)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT }}
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then echo "FIREBASE_TOKEN not provided; skipping firebase deploy"; else
            firebase deploy --token "$FIREBASE_TOKEN" ${FIREBASE_PROJECT:+--project "$FIREBASE_PROJECT"}
          fi
