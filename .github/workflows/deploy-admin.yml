# Firebase App Hosting - Admin Dashboard Auto-Deploy
name: Deploy Admin to Firebase App Hosting

on:
  push:
    branches:
      - main
      - blackboxai/bot2-run
    paths:
      - 'apps/admin/**'
      - 'packages/**'
      - 'apphosting.yaml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: royalcarriagelimoseo
      NODE_ENV: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate auth configuration
        run: |
          if [ -z "${{ secrets.WORKLOAD_IDENTITY_PROVIDER || '' }}" ] && [ -z "${{ secrets.GCP_SA_KEY || '' }}" ]; then
            echo "Missing auth: set WORKLOAD_IDENTITY_PROVIDER/WORKLOAD_IDENTITY_SERVICE_ACCOUNT for OIDC or provide GCP_SA_KEY service account JSON."
            exit 1
          fi

      - name: Authenticate to GCP (OIDC or service account key)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER || '' }}
          service_account: ${{ secrets.WORKLOAD_IDENTITY_SERVICE_ACCOUNT || '' }}
          credentials_json: ${{ secrets.GCP_SA_KEY || '' }}

      - name: Build admin dashboard
        run: |
          cd apps/admin
          pnpm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY || '' }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: royalcarriagelimoseo.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: royalcarriagelimoseo
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: royalcarriagelimoseo.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: 910418192896
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID || '' }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.16.0

      - name: Deploy to Firebase Hosting
        run: |
          cd apps/admin
          firebase deploy --project="$PROJECT_ID" --only hosting:admin --non-interactive
