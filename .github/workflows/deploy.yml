name: Deploy to Firebase Hosting

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      site:
        description: 'Site to deploy'
        required: true
        type: choice
        options:
          - airport
          - partybus
          - executive
          - wedding
          - all
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: npm test
        continue-on-error: false
      
      - name: Build application
        run: |
          cd client
          npm ci
          npm run build
        env:
          NODE_ENV: production
          VITE_GA4_ID: ${{ secrets.GA4_MEASUREMENT_ID }}
      
      - name: Generate sitemap
        run: npm run sitemap:generate
      
      - name: Verify build output
        run: |
          echo "Checking build output..."
          if [ ! -d "client/dist" ]; then
            echo "Error: Build output directory not found"
            exit 1
          fi
          
          echo "Build size:"
          du -sh client/dist
          
          echo "Verifying critical files..."
          if [ ! -f "client/dist/index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          
          if [ ! -f "client/public/sitemap.xml" ]; then
            echo "Warning: sitemap.xml not found"
          fi
          
          if [ ! -f "client/public/robots.txt" ]; then
            echo "Warning: robots.txt not found"
          fi
      
      - name: Authenticate to GCP (OIDC) — fallback when `FIREBASE_SERVICE_ACCOUNT` not provided
        if: ${{ !secrets.FIREBASE_SERVICE_ACCOUNT }}
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: 'projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL/providers/PROVIDER'
          service_account: 'SERVICE_ACCOUNT_EMAIL@PROJECT.iam.gserviceaccount.com'

      - name: Deploy to Firebase (hosting)
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: ${{ inputs.environment == 'production' && 'live' || 'staging' }}
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

      - name: Deploy to Firebase (hosting) — OIDC path
        if: ${{ !secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # When OIDC auth is configured via google-github-actions/auth, ADC is available
          echo "Deploying via firebase-tools using OIDC-authenticated ADC"
          npm install -g firebase-tools@13.16.0
          firebase deploy --project "${{ secrets.FIREBASE_PROJECT_ID }}" --only hosting --non-interactive
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
      
      - name: Post-deployment verification
        run: |
          echo "Deployment completed successfully!"
          echo "Environment: ${{ inputs.environment }}"
          echo "Site: ${{ inputs.site }}"
          echo ""
          echo "Next steps:"
          echo "1. Verify GA4 tracking in Google Analytics (24-48 hours)"
          echo "2. Submit sitemap to Google Search Console"
          echo "3. Test mobile responsiveness"
          echo "4. Check JSON-LD schemas in page source"
          echo "5. Monitor error logs for 24 hours"
      
      - name: Create deployment summary
        if: always()
        run: |
          cat << EOF > $GITHUB_STEP_SUMMARY
          ## Deployment Summary
          
          **Environment:** \`${{ inputs.environment }}\`
          **Site:** \`${{ inputs.site }}\`
          **Status:** ${{ job.status }}
          **Build Time:** $(date)
          
          ### Build Output
          - ✅ Client built successfully
          - ✅ Sitemap generated
          - ✅ Deployed to Firebase Hosting
          
          ### Post-Deployment Checklist
          - [ ] Verify site is accessible
          - [ ] Check GA4 tracking
          - [ ] Validate JSON-LD schemas
          - [ ] Test mobile CTA bar
          - [ ] Monitor error logs
          
          ### Important URLs
          - Production: https://chicagoairportblackcar.com
          - Admin: https://chicagoairportblackcar.com/admin
          - Firebase Console: https://console.firebase.google.com
          EOF
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check logs for details."
          echo "Common issues:"
          echo "- Build errors: Check npm build logs"
          echo "- Firebase credentials: Verify FIREBASE_SERVICE_ACCOUNT secret"
          echo "- Network issues: Retry deployment"
